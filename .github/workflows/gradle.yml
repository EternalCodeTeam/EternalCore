name: Java CI with Gradle

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java:
          - 21
      fail-fast: false
    steps:
      - name: Find existing build comment
        uses: peter-evans/find-comment@v3
        if: github.event_name == 'pull_request'
        id: init-find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'

      - name: Create placeholder comment
        uses: peter-evans/create-or-update-comment@v4
        if: |
          github.event_name == 'pull_request' &&
          steps.init-find-comment.outputs.comment-id == ''
        id: create-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ðŸš§ Build in progress...

            > [!NOTE]
            > A development build of **EternalCore** will be available here after the workflow completes.
          edit-mode: replace

      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4.7.1
        with:
          distribution: adopt
          java-version: '${{ matrix.java }}'

      - name: Cache Gradle
        uses: actions/cache@v4.2.3
        with:
          path: ~/.gradle/caches
          key: >-
            ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: '${{ runner.os }}-gradle-'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build the plugin
        run: ./gradlew clean eternalcore-plugin:shadowJar

      - name: Upload built JAR
        uses: actions/upload-artifact@v4.6.2
        id: upload-artifact
        with:
          name: EternalCore Dev Build
          path: eternalcore-plugin/build/libs/EternalCore*.jar
          retention-days: 14
          overwrite: true

      - name: Find final comment again
        uses: peter-evans/find-comment@v3
        if: github.event_name == 'pull_request'
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'

      - name: Update comment with download link
        uses: peter-evans/create-or-update-comment@v4
        if: github.event_name == 'pull_request'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: |
            ### ðŸ“¦ Development Build Ready

            > [!INFO]
            > A test build of **EternalCore** with the changes from this pull request is ready.

            ðŸ‘‰ [**Click here to download the JAR**](${{ steps.upload-artifact.outputs.artifact-url }})

            > [!WARNING]
            > **Do not use this build in production.** It is meant for testing purposes only and may be unstable.
          edit-mode: replace
          reactions: rocket
